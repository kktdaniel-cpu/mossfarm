<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Life 2.0 고백리 태양광 이끼 스마트팜 사업성 분석</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- FontAwesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* Custom Font - Noto Sans KR */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');
        
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #F3F4F6; /* Warm neutral background */
            color: #1F2937;
        }

        /* Chart Container Styling - MANDATORY */
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 100%; /* Parent controls width */
            margin-left: auto;
            margin-right: auto;
            height: 300px;
            max-height: 400px;
        }
        
        @media (min-width: 768px) {
            .chart-container {
                height: 350px;
            }
        }

        /* Input Range Styling */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #059669; /* Emerald 600 */
            cursor: pointer;
            margin-top: -6px;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            background: #D1FAE5;
            border-radius: 2px;
        }
        
        .card-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        .section-header {
            border-left: 4px solid #059669;
            padding-left: 1rem;
            margin-bottom: 1.5rem;
        }
    </style>
    
    <!-- Chosen Palette: Warm Neutrals & Eco Greens 
         - Background: #F3F4F6 (Cool Gray 100)
         - Primary Green: #059669 (Emerald 600)
         - Secondary/Accent: #10B981 (Emerald 500), #34D399 (Emerald 400)
         - Text: #1F2937 (Gray 800), #4B5563 (Gray 600)
         - Warning/Attention: #F59E0B (Amber 500)
    -->

    <!-- Application Structure Plan: 
         1. Header & Project Context: Immediate identification of the Gobaek-ri site and Life 2.0's role.
         2. Scenario Control Panel: Sidebar/Top section allowing dynamic adjustment of moss pricing, harvest cycles, and solar efficiency. This transforms the report into a simulator.
         3. Financial Dashboard (The Core):
            - CAPEX Breakdown: Solar vs. Moss investment.
            - Revenue Analysis: Visualizing the "Agriculture > Solar" requirement for licensing.
            - ROI Projection: 10-year cumulative cash flow.
         4. Strategic Value Section: K-Taxonomy, Carbon offsets (Pine tree equivalent), and Regulatory compliance (Agriculture as Main).
         5. Detailed Breakdown: Table view of specific costs derived from the PPT and Contract.
         
         WHY: The user needs to prove to investors/regulators that moss farming is viable and dominant. A static report is less convincing than a simulator where they can test "What if moss prices drop?" or "What if we harvest 4 times a year?".
    -->

    <!-- Visualization & Content Choices:
         - Revenue Comparison (Doughnut Chart): Goal: Compare. Shows Solar vs. Moss income share. Critical for proving "Main Business is Agriculture".
         - 10-Year ROI (Line Chart): Goal: Change. Shows long-term profitability and break-even point.
         - CAPEX Breakdown (Stacked Bar): Goal: Inform. Clearly separates Land/Solar/Moss facility costs.
         - Carbon Offset (Iconography/Counter): Goal: Inform. Translates "trays" to "pine trees" based on PPT data.
         - Logic: All charts update in real-time via Vanilla JS + Chart.js.
    -->

    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
</head>
<body class="antialiased">

    <!-- Navbar -->
    <nav class="bg-white border-b border-gray-200 fixed w-full z-10 top-0">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0 flex items-center">
                        <i class="fa-solid fa-leaf text-emerald-600 text-2xl mr-2"></i>
                        <span class="font-bold text-xl tracking-tight text-gray-800">Life 2.0 <span class="text-emerald-600">Smart Farm Analysis</span></span>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="px-3 py-1 rounded-full text-xs font-medium bg-emerald-100 text-emerald-800">K-Taxonomy 적합</span>
                    <span class="px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">소셜벤처(SV)</span>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Layout -->
    <div class="pt-20 pb-12 px-4 sm:px-6 lg:px-8 max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-6">

        <!-- Left Column: Controls & Project Info (4 cols) -->
        <div class="lg:col-span-4 space-y-6">
            
            <!-- Project Overview Card -->
            <div class="bg-white rounded-xl card-shadow p-6">
                <h2 class="text-lg font-bold text-gray-800 mb-4 section-header">프로젝트 개요 (고백리)</h2>
                <div class="space-y-3 text-sm text-gray-600">
                    <div class="flex justify-between border-b pb-2">
                        <span class="font-medium">위치</span>
                        <span class="text-right">경기도 이천시 부발읍<br>고백리 40-1</span>
                    </div>
                    <div class="flex justify-between border-b pb-2">
                        <span class="font-medium">발전 용량</span>
                        <span class="text-gray-900 font-bold">99 kW</span>
                    </div>
                    <div class="flex justify-between border-b pb-2">
                        <span class="font-medium">모듈 설치 면적</span>
                        <span>462 ㎡ (약 140평)</span>
                    </div>
                    <div class="flex justify-between border-b pb-2">
                        <span class="font-medium">이끼 재배 방식</span>
                        <span>모듈형 스마트팜<br>(비접지/가변형)</span>
                    </div>
                    <div class="mt-4 p-3 bg-gray-50 rounded-lg text-xs leading-relaxed">
                        <i class="fa-solid fa-info-circle text-emerald-500 mr-1"></i>
                        본 시뮬레이션은 <strong>태양광 발전 수익</strong>과 <strong>이끼 재배 수익</strong>을 통합 분석하여, 농업 경영이 주 사업임을 입증하고 인허가 및 사업성을 검증하기 위함입니다.
                    </div>
                </div>
            </div>

            <!-- Simulation Controls -->
            <div class="bg-white rounded-xl card-shadow p-6 sticky top-24">
                <h2 class="text-lg font-bold text-gray-800 mb-4 section-header flex items-center justify-between">
                    <span>시나리오 설정</span>
                    <button onclick="resetDefaults()" class="text-xs font-normal text-gray-400 hover:text-emerald-600 underline">초기화</button>
                </h2>
                
                <div class="space-y-6">
                    <!-- Moss Price Control -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            이끼 도매 단가 (1판 기준)
                            <span id="priceDisplay" class="float-right font-bold text-emerald-600">15,000 원</span>
                        </label>
                        <input type="range" id="mossPriceInput" min="8000" max="25000" step="500" value="15000">
                        <div class="flex justify-between text-xs text-gray-400 mt-1">
                            <span>보수적(8천원)</span>
                            <span>낙관적(2.5만원)</span>
                        </div>
                    </div>

                    <!-- Harvest Cycles Control -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            연간 수확 횟수 (회전율)
                            <span id="cycleDisplay" class="float-right font-bold text-emerald-600">3 회</span>
                        </label>
                        <input type="range" id="harvestCycleInput" min="1" max="6" step="1" value="3">
                        <p class="text-xs text-gray-500 mt-1">* 3단 스마트팜 모듈 기준</p>
                    </div>

                    <!-- Solar Efficiency Control -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            일평균 발전시간
                            <span id="solarHoursDisplay" class="float-right font-bold text-emerald-600">3.6 시간</span>
                        </label>
                        <input type="range" id="solarHoursInput" min="2.5" max="4.5" step="0.1" value="3.6">
                    </div>

                    <div class="pt-4 border-t border-gray-100">
                        <div class="flex items-center mb-2">
                            <input type="checkbox" id="includeRetail" class="rounded text-emerald-600 focus:ring-emerald-500 h-4 w-4">
                            <label for="includeRetail" class="ml-2 text-sm text-gray-700">소매 판매(체험/반려식물) 20% 포함</label>
                        </div>
                    </div>

                    <button id="calculateBtn" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 shadow-md">
                        <i class="fa-solid fa-calculator mr-2"></i> 시나리오 재계산
                    </button>
                </div>
            </div>
        </div>

        <!-- Right Column: Dashboard & Charts (8 cols) -->
        <div class="lg:col-span-8 space-y-6">
            
            <!-- Introduction Text -->
            <div class="bg-white rounded-xl card-shadow p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-2">사업성 분석 대시보드</h3>
                <p class="text-gray-600 leading-relaxed text-sm">
                    본 대시보드는 <strong>고백리 태양광 발전소</strong> 사이트 실증을 위한 종합 분석 도구입니다. 
                    단순한 이끼 공급을 넘어, <span class="text-emerald-600 font-bold">초기 투자비(CAPEX)</span> 대비 
                    <span class="text-emerald-600 font-bold">운영 수익(OPEX, Sales)</span>을 시뮬레이션합니다. 
                    특히 인허가상 필수적인 <strong>'농업 소득 > 발전 소득'</strong> 달성 여부를 실시간으로 판정하여, 
                    전략적인 영농형 태양광 사업 모델을 제시합니다.
                </p>
            </div>

            <!-- KPI Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-white rounded-xl card-shadow p-4 border-l-4 border-gray-500">
                    <div class="text-xs text-gray-500 uppercase font-bold mb-1">총 초기 투자비 (CAPEX)</div>
                    <div class="text-2xl font-bold text-gray-800" id="totalCapex">2.4 억원</div>
                    <div class="text-xs text-gray-500 mt-1">태양광 + 이끼 재배사 설비</div>
                </div>
                <div class="bg-white rounded-xl card-shadow p-4 border-l-4 border-amber-500">
                    <div class="text-xs text-gray-500 uppercase font-bold mb-1">연간 태양광 매출 (예상)</div>
                    <div class="text-2xl font-bold text-gray-800" id="solarRevenue">2,400 만원</div>
                    <div class="text-xs text-gray-500 mt-1">SMP + REC 가중치 적용</div>
                </div>
                <div class="bg-white rounded-xl card-shadow p-4 border-l-4 border-emerald-500">
                    <div class="text-xs text-gray-500 uppercase font-bold mb-1">연간 이끼 매출 (예상)</div>
                    <div class="text-2xl font-bold text-emerald-600" id="mossRevenue">4,500 만원</div>
                    <div class="text-xs text-gray-500 mt-1" id="mossRevenueNote">보수적 관점 적용 시</div>
                </div>
            </div>

            <!-- Compliance Status Banner -->
            <div id="complianceBanner" class="bg-emerald-50 border border-emerald-200 rounded-lg p-4 flex items-start space-x-3">
                <div class="flex-shrink-0">
                    <i class="fa-solid fa-check-circle text-emerald-500 text-xl mt-1"></i>
                </div>
                <div>
                    <h4 class="text-md font-bold text-emerald-800">인허가 기준 충족 (농업 소득 우위)</h4>
                    <p class="text-sm text-emerald-700 mt-1">
                        현재 시나리오 상 이끼 재배 매출이 태양광 발전 매출을 초과하여, 
                        농업이 주 사업(Main)으로 인정받을 수 있는 조건을 충족합니다.
                    </p>
                </div>
            </div>

            <!-- Charts Row 1: Revenue Structure -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Revenue Mix Chart -->
                <div class="bg-white rounded-xl card-shadow p-6 flex flex-col">
                    <h3 class="text-md font-bold text-gray-800 mb-4 text-center">매출 비중 분석 (Business Portfolio)</h3>
                    <div class="flex-grow flex items-center justify-center">
                        <div class="chart-container">
                            <canvas id="revenueMixChart"></canvas>
                        </div>
                    </div>
                    <p class="text-xs text-center text-gray-400 mt-2">이끼 매출 비중이 높을수록 인허가 안정성 확보</p>
                </div>

                <!-- ROI Line Chart -->
                <div class="bg-white rounded-xl card-shadow p-6 flex flex-col">
                    <h3 class="text-md font-bold text-gray-800 mb-4 text-center">10년 누적 순수익 (ROI)</h3>
                    <div class="flex-grow flex items-center justify-center">
                        <div class="chart-container">
                            <canvas id="roiChart"></canvas>
                        </div>
                    </div>
                    <p class="text-xs text-center text-gray-400 mt-2">투자금 회수 기간(BEP) 및 장기 수익성</p>
                </div>
            </div>

            <!-- Detailed Cost Breakdown Table -->
            <div class="bg-white rounded-xl card-shadow overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                    <h3 class="font-bold text-gray-800">세부 수지 분석 (단위: 천원)</h3>
                    <span class="text-xs text-gray-500">* 부가세 별도 / 운영비는 연간 상승률 2% 적용 가정</span>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-600">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50 border-b">
                            <tr>
                                <th class="px-6 py-3">구분</th>
                                <th class="px-6 py-3">항목</th>
                                <th class="px-6 py-3 text-right">금액/산출근거</th>
                                <th class="px-6 py-3 text-right">비고</th>
                            </tr>
                        </thead>
                        <tbody id="costTableBody" class="divide-y divide-gray-100">
                            <!-- JS Generated Rows -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ESG Impact Section -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-gradient-to-br from-emerald-600 to-teal-700 rounded-xl card-shadow p-6 text-white">
                    <h3 class="font-bold text-lg mb-4"><i class="fa-solid fa-tree mr-2"></i>탄소 감축 효과 (ESG)</h3>
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="text-3xl font-bold mb-1" id="treeEquivalent">450 그루</div>
                            <div class="text-sm opacity-90">35년생 소나무 환산 (연간)</div>
                        </div>
                        <div class="text-5xl opacity-20">
                            <i class="fa-solid fa-cloud-open"></i>
                        </div>
                    </div>
                    <div class="mt-4 text-xs opacity-80 leading-relaxed border-t border-white/20 pt-3">
                        * 근거: 3단 스마트팜 1기(72판) = 소나무 10그루 흡수 효과 (PPT 데이터 기준)<br>
                        * 고백리 현장 예상 설치 모듈 기준 산출
                    </div>
                </div>

                <div class="bg-white rounded-xl card-shadow p-6">
                    <h3 class="font-bold text-gray-800 mb-3">전략적 시사점 (Life 2.0)</h3>
                    <ul class="space-y-3 text-sm text-gray-600">
                        <li class="flex items-start">
                            <i class="fa-solid fa-check text-emerald-500 mt-1 mr-2"></i>
                            <span><strong>K-Taxonomy(한국형 녹색분류체계):</strong> 농업과 재생에너지 융합 모델로서 녹색 금융 지원 가능성 확보.</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fa-solid fa-check text-emerald-500 mt-1 mr-2"></i>
                            <span><strong>인허가 전략:</strong> 이끼 스마트팜을 '주된 사업'으로 포지셔닝하여 농지법 및 태양광 이격거리 규제 이슈 해소.</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fa-solid fa-check text-emerald-500 mt-1 mr-2"></i>
                            <span><strong>지역 상생:</strong> 단순 발전소가 아닌 주민 참여형 스마트팜 모델 제안 가능.</span>
                        </li>
                    </ul>
                </div>
            </div>

        </div>
    </div>

    <!-- JavaScript Implementation -->
    <script>
        // --- State Management ---
        const state = {
            mossPrice: 15000,
            harvestCycles: 3,
            solarHours: 3.6,
            includeRetail: false,
            // Fixed Constants from Source Data
            solarCapacity: 99, // kW
            rackCount: 50, // Estimated feasible racks for 462sqm (allowing for pathways)
            traysPerRack: 72, // 3-tier unit (Source: PPT)
            costPerRack3Tier: 690000, // KRW (Source: PPT)
            trayCost: 12000, // KRW (Source: PPT, seeds included)
            smpRecPrice: 180, // KRW/kWh (Estimated Blended Price)
            solarInstallCostPerKw: 1300000, // KRW (Estimated 1.3m per kW)
            baseOperCostRatio: 0.05, // 5% of revenue for OPEX
        };

        // --- Chart Instances ---
        let revenueMixChartInstance = null;
        let roiChartInstance = null;

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            initEventListeners();
            updateDashboard();
        });

        function initEventListeners() {
            document.getElementById('mossPriceInput').addEventListener('input', (e) => {
                state.mossPrice = parseInt(e.target.value);
                document.getElementById('priceDisplay').textContent = state.mossPrice.toLocaleString() + ' 원';
                updateDashboard();
            });

            document.getElementById('harvestCycleInput').addEventListener('input', (e) => {
                state.harvestCycles = parseInt(e.target.value);
                document.getElementById('cycleDisplay').textContent = state.harvestCycles + ' 회';
                updateDashboard();
            });

            document.getElementById('solarHoursInput').addEventListener('input', (e) => {
                state.solarHours = parseFloat(e.target.value);
                document.getElementById('solarHoursDisplay').textContent = state.solarHours + ' 시간';
                updateDashboard();
            });

            document.getElementById('includeRetail').addEventListener('change', (e) => {
                state.includeRetail = e.target.checked;
                updateDashboard();
            });

            document.getElementById('calculateBtn').addEventListener('click', updateDashboard);
        }

        function resetDefaults() {
            state.mossPrice = 15000;
            state.harvestCycles = 3;
            state.solarHours = 3.6;
            state.includeRetail = false;
            
            document.getElementById('mossPriceInput').value = 15000;
            document.getElementById('harvestCycleInput').value = 3;
            document.getElementById('solarHoursInput').value = 3.6;
            document.getElementById('includeRetail').checked = false;
            
            // Update displays
            document.getElementById('priceDisplay').textContent = '15,000 원';
            document.getElementById('cycleDisplay').textContent = '3 회';
            document.getElementById('solarHoursDisplay').textContent = '3.6 시간';
            
            updateDashboard();
        }

        // --- Core Logic ---
        function calculateMetrics() {
            // 1. CAPEX Calculation
            // Solar: 99kW * ~1.3m KRW
            const solarCapex = state.solarCapacity * state.solarInstallCostPerKw;
            
            // Moss Hardware: Racks + Irrigation (Assume irrigation is ~50% of rack cost for robust system)
            const mossHardwareCapex = (state.rackCount * state.costPerRack3Tier) * 1.5; 
            
            // Initial Moss Seeds (First batch)
            const mossSeedCapex = state.rackCount * state.traysPerRack * state.trayCost;
            
            const totalCapex = solarCapex + mossHardwareCapex + mossSeedCapex;

            // 2. Revenue Calculation
            // Solar: kW * hours * 365 * Price
            const solarAnnualRevenue = state.solarCapacity * state.solarHours * 365 * state.smpRecPrice;

            // Moss: Racks * Trays * Cycles * Price
            // Apply Retail Premium if checked (20% of volume sold at double price)
            let avgPrice = state.mossPrice;
            if (state.includeRetail) {
                avgPrice = (state.mossPrice * 0.8) + ((state.mossPrice * 2.0) * 0.2);
            }
            
            // Assuming 10% loss rate in production
            const effectiveTrays = state.rackCount * state.traysPerRack * 0.9; 
            const mossAnnualRevenue = effectiveTrays * state.harvestCycles * avgPrice;

            // 3. OPEX Calculation
            // Solar O&M: ~1.5% of CAPEX
            const solarOpex = solarCapex * 0.015;
            
            // Moss OPEX: Labor, Water, Electricity, Re-seeding (assume 30% of revenue for COGS/Labor)
            const mossOpex = mossAnnualRevenue * 0.35; 

            return {
                capex: { solar: solarCapex, moss: mossHardwareCapex + mossSeedCapex, total: totalCapex },
                revenue: { solar: solarAnnualRevenue, moss: mossAnnualRevenue },
                opex: { solar: solarOpex, moss: mossOpex },
                netIncome: (solarAnnualRevenue + mossAnnualRevenue) - (solarOpex + mossOpex)
            };
        }

        function updateDashboard() {
            const metrics = calculateMetrics();

            // Update KPI Cards
            document.getElementById('totalCapex').textContent = (metrics.capex.total / 100000000).toFixed(1) + " 억원";
            document.getElementById('solarRevenue').textContent = Math.round(metrics.revenue.solar / 10000).toLocaleString() + " 만원";
            document.getElementById('mossRevenue').textContent = Math.round(metrics.revenue.moss / 10000).toLocaleString() + " 만원";

            // Compliance Banner Logic
            const banner = document.getElementById('complianceBanner');
            const note = document.getElementById('mossRevenueNote');
            
            if (metrics.revenue.moss > metrics.revenue.solar) {
                banner.className = "bg-emerald-50 border border-emerald-200 rounded-lg p-4 flex items-start space-x-3";
                banner.innerHTML = `
                    <div class="flex-shrink-0"><i class="fa-solid fa-check-circle text-emerald-500 text-xl mt-1"></i></div>
                    <div>
                        <h4 class="text-md font-bold text-emerald-800">인허가 기준 충족 (농업 소득 우위)</h4>
                        <p class="text-sm text-emerald-700 mt-1">이끼 재배 매출이 태양광 매출보다 높습니다. (비율 ${(metrics.revenue.moss/metrics.revenue.solar).toFixed(1)}배)</p>
                    </div>`;
                note.textContent = "태양광 매출 상회 (성공적 시나리오)";
                note.className = "text-xs font-bold text-emerald-600 mt-1";
            } else {
                banner.className = "bg-amber-50 border border-amber-200 rounded-lg p-4 flex items-start space-x-3";
                banner.innerHTML = `
                    <div class="flex-shrink-0"><i class="fa-solid fa-exclamation-triangle text-amber-500 text-xl mt-1"></i></div>
                    <div>
                        <h4 class="text-md font-bold text-amber-800">인허가 기준 미달 위험 (농업 소득 열위)</h4>
                        <p class="text-sm text-amber-700 mt-1">이끼 재배 매출을 늘려야 농지법상 유리합니다. 수확 횟수나 단가를 조정하세요.</p>
                    </div>`;
                note.textContent = "태양광 매출 하회 (주의 필요)";
                note.className = "text-xs font-bold text-amber-600 mt-1";
            }

            // Update Tree Count (Source: PPT says 72 trays (1 rack) = 10 trees)
            const treeCount = state.rackCount * 10;
            document.getElementById('treeEquivalent').textContent = treeCount.toLocaleString() + " 그루";

            // Render Charts
            renderRevenueChart(metrics);
            renderRoiChart(metrics);

            // Update Table
            updateCostTable(metrics);
        }

        // --- Table Rendering ---
        function updateCostTable(metrics) {
            const tbody = document.getElementById('costTableBody');
            const rows = [
                { cat: '초기투자(CAPEX)', item: '태양광 발전설비 (99kW)', cost: metrics.capex.solar, note: '모듈, 인버터, 구조물' },
                { cat: '초기투자(CAPEX)', item: '이끼 스마트팜 설비', cost: metrics.capex.moss, note: `${state.rackCount}기 (3단), 관수, 초기종자` },
                { cat: '예상매출(연간)', item: '태양광 발전 수익', cost: metrics.revenue.solar, note: `SMP+REC 통합단가 ${state.smpRecPrice}원 적용` },
                { cat: '예상매출(연간)', item: '이끼 판매 수익', cost: metrics.revenue.moss, note: `연 ${state.harvestCycles}회전, 도매/소매 복합` },
                { cat: '운영비용(연간)', item: '총 운영비 (OPEX)', cost: metrics.opex.solar + metrics.opex.moss, note: '인건비, 자재, 유지보수' },
                { cat: '영업이익(연간)', item: '순수익 (Net Profit)', cost: metrics.netIncome, note: '세전 이익' },
            ];

            tbody.innerHTML = rows.map(row => `
                <tr class="hover:bg-gray-50 transition">
                    <td class="px-6 py-4 font-medium text-gray-900">${row.cat}</td>
                    <td class="px-6 py-4">${row.item}</td>
                    <td class="px-6 py-4 text-right font-bold">${Math.round(row.cost).toLocaleString()}</td>
                    <td class="px-6 py-4 text-right text-xs text-gray-500">${row.note}</td>
                </tr>
            `).join('');
        }

        // --- Chart Rendering Functions ---
        
        function renderRevenueChart(metrics) {
            const ctx = document.getElementById('revenueMixChart').getContext('2d');
            
            if (revenueMixChartInstance) revenueMixChartInstance.destroy();

            revenueMixChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['태양광 매출', '이끼 재배 매출'],
                    datasets: [{
                        data: [metrics.revenue.solar, metrics.revenue.moss],
                        backgroundColor: ['#9CA3AF', '#059669'], // Gray for Solar (tech), Green for Moss (nature)
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let value = context.raw;
                                    let total = context.chart._metasets[context.datasetIndex].total;
                                    let percentage = Math.round((value / total) * 100) + '%';
                                    return context.label + ': ' + Math.round(value/10000).toLocaleString() + '만원 (' + percentage + ')';
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderRoiChart(metrics) {
            const ctx = document.getElementById('roiChart').getContext('2d');
            
            // Generate 10-year data
            const labels = Array.from({length: 11}, (_, i) => `${i}년차`);
            const cumulativeCashFlow = [];
            
            let currentBalance = -metrics.capex.total; // Start with negative investment
            cumulativeCashFlow.push(currentBalance); // Year 0

            for (let i = 1; i <= 10; i++) {
                // Simple inflation logic: Revenue +2%, OPEX +2% per year
                const inflationFactor = Math.pow(1.02, i-1); 
                const yearlyNet = (metrics.netIncome * inflationFactor);
                currentBalance += yearlyNet;
                cumulativeCashFlow.push(currentBalance);
            }

            if (roiChartInstance) roiChartInstance.destroy();

            roiChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '누적 순현금흐름 (Cumulative Cash Flow)',
                        data: cumulativeCashFlow,
                        borderColor: '#059669',
                        backgroundColor: 'rgba(5, 150, 105, 0.1)',
                        fill: true,
                        tension: 0.3,
                        pointRadius: 4,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: '#059669',
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            grid: { color: '#F3F4F6' },
                            ticks: {
                                callback: function(value) {
                                    return (value / 100000000).toFixed(1) + '억';
                                }
                            }
                        },
                        x: {
                            grid: { display: false }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return '누적: ' + Math.round(context.raw/10000).toLocaleString() + '만원';
                                }
                            }
                        },
                        annotation: { // Conceptual logic for BEP line
                            annotations: {
                                line1: {
                                    type: 'line',
                                    yMin: 0,
                                    yMax: 0,
                                    borderColor: 'rgba(0,0,0,0.3)',
                                    borderWidth: 2,
                                    borderDash: [5, 5]
                                }
                            }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>